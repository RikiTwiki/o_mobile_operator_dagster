# -*- coding: utf-8 -*-
# test.py — standalone версия блока "Конверсия подключений" на новом MultiAxisChart (HTML/ApexCharts)

import math
from typing import List, Dict, Any

import base64

from datetime import datetime

from user_code.utils.templates.charts.gtm_multi_axis_chart import GTMMultiAxisChart


# --- ДАННЫЕ-ПРИМЕР ---
RESULT: List[Dict[str, Any]] = [
    {'date': '2025-08-14', 'Соединено': 732, 'кол-во подключений': 45, 'соединено / кол-во подключений': 6.1},
    {'date': '2025-08-15', 'Соединено': 336, 'кол-во подключений': 13, 'соединено / кол-во подключений': 3.9},
    {'date': '2025-08-16', 'Соединено': 884, 'кол-во подключений': 46, 'соединено / кол-во подключений': 5.2},
    {'date': '2025-08-17', 'Соединено': 514, 'кол-во подключений': 28, 'соединено / кол-во подключений': 5.4},
    {'date': '2025-08-18', 'Соединено': 953, 'кол-во подключений': 41, 'соединено / кол-во подключений': 4.3},
    {'date': '2025-08-19', 'Соединено': 1378, 'кол-во подключений': 67, 'соединено / кол-во подключений': 4.9},
    {'date': '2025-08-20', 'Соединено': 1919, 'кол-во подключений': 77, 'соединено / кол-во подключений': 4.0},
    {'date': '2025-08-21', 'Соединено': 1080, 'кол-во подключений': 33, 'соединено / кол-во подключений': 3.1},
    {'date': '2025-08-22', 'Соединено': 30,  'кол-во подключений': 0,  'соединено / кол-во подключений': 0.0},
    {'date': '2025-08-23', 'Соединено': 616, 'кол-во подключений': 33, 'соединено / кол-во подключений': 5.4},
    {'date': '2025-08-24', 'Соединено': 645, 'кол-во подключений': 30, 'соединено / кол-во подключений': 4.7},
    {'date': '2025-08-25', 'Соединено': 543, 'кол-во подключений': 23, 'соединено / кол-во подключений': 4.2},
    {'date': '2025-08-26', 'Соединено': 1177,'кол-во подключений': 83, 'соединено / кол-во подключений': 7.1},
    {'date': '2025-08-27', 'Соединено': 1402,'кол-во подключений': 43, 'соединено / кол-во подключений': 3.1},
    {'date': '2025-08-28', 'Соединено': 1406,'кол-во подключений': 78, 'соединено / кол-во подключений': 5.5},
    {'date': '2025-08-29', 'Соединено': 761, 'кол-во подключений': 41, 'соединено / кол-во подключений': 5.4},
    {'date': '2025-08-30', 'Соединено': 1493,'кол-во подключений': 63, 'соединено / кол-во подключений': 4.2},
    {'date': '2025-08-31', 'Соединено': 1010,'кол-во подключений': 56, 'соединено / кол-во подключений': 5.5},
    {'date': '2025-09-02', 'Соединено': 1141,'кол-во подключений': 53, 'соединено / кол-во подключений': 4.6},
    {'date': '2025-09-03', 'Соединено': 1880,'кол-во подключений': 97, 'соединено / кол-во подключений': 5.2},
    {'date': '2025-09-04', 'Соединено': 1720,'кол-во подключений': 52, 'соединено / кол-во подключений': 3.0},
    {'date': '2025-09-05', 'Соединено': 890, 'кол-во подключений': 55, 'соединено / кол-во подключений': 6.2},
    {'date': '2025-09-06', 'Соединено': 745, 'кол-во подключений': 38, 'соединено / кол-во подключений': 5.1},
    {'date': '2025-09-07', 'Соединено': 546, 'кол-во подключений': 27, 'соединено / кол-во подключений': 4.9},
    {'date': '2025-09-08', 'Соединено': 453, 'кол-во подключений': 14, 'соединено / кол-во подключений': 3.1},
    {'date': '2025-09-09', 'Соединено': 97,  'кол-во подключений': 6,  'соединено / кол-во подключений': 6.2},
    {'date': '2025-09-10', 'Соединено': 925, 'кол-во подключений': 54, 'соединено / кол-во подключений': 5.8},
    {'date': '2025-09-11', 'Соединено': 430, 'кол-во подключений': 21, 'соединено / кол-во подключений': 4.9},
    {'date': '2025-09-12', 'Соединено': 192, 'кол-во подключений': 29, 'соединено / кол-во подключений': 15.1},
    {'date': '2025-09-13', 'Соединено': 198, 'кол-во подключений': 34, 'соединено / кол-во подключений': 17.2},
    {'date': '2025-09-14', 'Соединено': 300, 'кол-во подключений': 38, 'соединено / кол-во подключений': 12.7},
]


def build_chart_png(general_connections_ratio: List[Dict[str, Any]]) -> str:
    data = general_connections_ratio or []

    # max по "соединено"
    max_connected = 0
    for item in data:
        val = int(item.get("соединено", item.get("Соединено", 0)) or 0)
        if val > max_connected:
            max_connected = val

    # max *= 1.5; ceil(max/1000)*1000
    y_max = int(math.ceil((max_connected * 1.5) / 1000.0) * 1000) if max_connected > 0 else 1000

    # типизация + мягкая сортировка по дате
    norm: List[Dict[str, Any]] = []
    for it in data:
        norm.append({
            "date": it["date"],
            "соединено": int(it.get("соединено", it.get("Соединено", 0)) or 0),
            "кол-во подключений": int(it.get("кол-во подключений", 0) or 0),
            "соединено / кол-во подключений": float(it.get("соединено / кол-во подключений", 0.0) or 0.0),
        })
    try:
        norm.sort(key=lambda x: datetime.strptime(x["date"], "%Y-%m-%d"))
    except Exception:
        pass

    # Конфигурация GTMMultiAxisChart
    chart = GTMMultiAxisChart(dot=True, is_marker=False)
    chart.GraphTitle = ""
    chart.YAxesName = "Количество"
    chart.XAxesName = "Дата"
    chart.Items = norm

    chart.YAxesMin = 0
    chart.YAxesMax = y_max
    chart.Pointer = 500
    chart.Height = 450

    chart.HideRightAxis = True  # как в оригинале
    chart.Combine(4, 20, -25)   # правая ось: [-25..25]

    # Бары рядом (а не стек): chartType="grouped_bars"
    chart.Fields = [
        {"field": "date", "title": "", "type": "label"},
        {"field": "кол-во подключений", "title": "Количество подключений", "chartType": "grouped_bars", "round": 0},
        {"field": "соединено", "title": "Количество дозвонов", "chartType": "grouped_bars", "round": 0},
        {"field": "соединено / кол-во подключений", "title": "Конверсия", "chartType": "line", "postfix": "%"},
    ]

    try:
        chart.setColourPack(6)
    except Exception:
        pass

    # Рендер → PNG base64 (renderGraphics теперь возвращает PNG base64)
    b64 = chart.renderGraphics()
    print(f"[ok] rows={len(norm)}, y_max={y_max}")
    return b64


def save_png_base64(b64: str, path: str) -> None:
    with open(path, "wb") as f:
        f.write(base64.b64decode(b64))


if __name__ == "__main__":
    b64 = build_chart_png(RESULT)
    out_path = "connections_ratio_test.png"
    save_png_base64(b64, out_path)
    print(f"[ok] Сохранено: {out_path}")